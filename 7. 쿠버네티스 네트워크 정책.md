# âœ…ë„¤íŠ¸ì›Œí¬ ì •ì±…ì´ë€?
**íŒŒë“œ ë° ì—”ë“œí¬ì¸íŠ¸ ê°„ íŠ¸ë˜í”½ íë¦„(Ingress/Egress)ì„ ì œì–´í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤**
- ê¸°ë³¸ì ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ëŠ” ë„¤íŠ¸ì›Œí¬ ëª¨ë¸ íŠ¹ì„± ìƒ ëª¨ë“  íŒŒë“œê°€ ì„œë¡œ í†µì‹  ê°€ëŠ¥

**ë³´ì•ˆì´ë‚˜ ì„œë¹„ìŠ¤ ê²©ë¦¬ë¥¼ ìœ„í•´ íŠ¹ì • íŒŒë“œ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ í†µì‹ ì„ ì°¨ë‹¨í•˜ê±°ë‚˜ í—ˆìš©í•˜ëŠ” ì •ì±…**
- ë‹¨, `NetworkPolicy` ë¦¬ì†ŒìŠ¤ë¥¼ ì§€ì›í•˜ëŠ” CNIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ ì‹¤ì œ ë™ì‘
  - `Flannel`ì€ ì§€ì› X
  
![](https://velog.velcdn.com/images/alstjr971/post/81bda1e9-4b66-4049-9417-2ba52e0fc505/image.png)

> ë¹„ìœ í•˜ë©´ ì¸í„°ë„· ë°©í™”ë²½ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ í•œë‹¤.
- ë‹¤ë§Œ ë°©í™”ë²½ì€ ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì œì–´í•˜ê³ ,
- ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ íŒŒë“œ ê°„ íŠ¸ë˜í”½ë„ ì œì–´í•œë‹¤ëŠ” ë²”ìœ„ì™€ ëŒ€ìƒ ê´€ì ì˜ ì°¨ì´ê°€ ì¡´ì¬

# âœ…ë„¤íŠ¸ì›Œí¬ ì •ì±…ì˜ í•„ìš”ì„±
- ê¸°ë³¸ì ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë³´ì•ˆ ëª¨ë¸ì€ `All Allow`
  - í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ëª¨ë“  íŒŒë“œ ê°„ í†µì‹ ì€ ììœ ë¡œìš°ë©°, L3/L4 ë„¤íŠ¸ì›Œí¬ê°€ ê°œë°©ë˜ì–´ ìˆìŒ
- ì·¨ì•½í•œ íŒŒë“œë¥¼ í†µí•œ ê³µê²©ìì˜ ì ‘ê·¼, ê°œë°œ/ìš´ì˜ í™˜ê²½ì˜ ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬
  - ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸ ëª¨ë¸ì„ ì ìš©í•˜ê¸° ìœ„í•œ ì ‘ê·¼ì œì–´ ì ìš©
  
![](https://velog.velcdn.com/images/alstjr971/post/fefbaa56-2b91-4048-8167-81faf7e897c7/image.png)


# âœ…ë„¤íŠ¸ì›Œí¬ ì •ì±… í•µì‹¬ êµ¬ì„± ìš”ì†Œì±… í•µì‹¬ êµ¬ì„± ìš”ì†Œ


### 1ï¸âƒ£ podSelector
- NetworkPolicyê°€ ì–´ë–¤ íŒŒë“œì— ì ìš©ë  ì§€ ê²°ì •í•˜ëŠ” í•„ë“œ
- labelê¸°ë°˜ ì„ íƒì ì‚¬ìš©(e.g app=nginx)

- `app=nginx` ë¼ë²¨ì´ ì ìš©ëœ íŒŒë“œì— ëŒ€í•œ `ingress` ì œí•œ ì˜ˆì‹œ

`deny-all-to-nginx.yaml`
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-to-nginx
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
    - Ingress
  ingress:
    - {} # Deny All Ingress
```

```bash
kubectl run nginx --image=nginx --labels="app=nginx" --port=80
kubectl run client --image=busybox:1.28 --restart=Never -it --rm --sh
# curl http://nginx -> ì„±ê³µ


kubectl apply -f deny-all-to-nginx.yaml
kubectl run client --image=busybox:1.28 --restart=Never -it --rm --sh
# curl http://nginx -> ì‹¤íŒ¨

kubectl delete networkpolicy --all
```

### 2ï¸âƒ£ namespaceSelector
- ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ Podë¡œë¶€í„°ì˜ ì ‘ê·¼ í—ˆìš©/ì œí•œ
- matchLabelsë¥¼ í†µí•´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í•„í„°ë§
- ex) í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ê°€ ìš´ì˜ API í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ë°©ì§€

`allow-from-frontend-ns.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-frontend-ns
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
    - Ingress
  ingress:
    - from:
      - namespaceSelector:
        matchLabels:
          team: frontend
```

```bash
kubectl create ns frontend # frontendë¼ëŠ” ì´ë¦„ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
kubectl create ns dev # devë¼ëŠ” ì´ë¦„ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
kubectl run nginx --image=nginx --labels="app=nginx" --port=80 --expose -n deafult # nginxë¼ëŠ” ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„± -> default ë„¤ì„ìŠ¤í˜ì´ìŠ¤
kubectl run client --image=busybox:1.28 --restart=Never -it --labels="team=frontend" -n frontend --sh # client ë¼ëŠ” ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ -> team=frontend ë¼ë²¨ì„ ê°–ê³  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” frontend

kubectl label ns frontend team=frontend # frontendë¼ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— team=frontendë¼ëŠ” ë¼ë²¨ ì¶”ê°€

kubectl apply -f allow-from-frontend-ns.yaml

kubectl run cliend --image=busybox:1.28 --restart=Never -it --rm -n frontend --sh # curl http://nginx -> ì„±ê³µ

kubectl run client --image=busybox:1.28 --restart=Never -it -n dev --sh # curl http://nginx -> ì‹¤íŒ¨

kubectl delete networkpolicy --all

```

> podSelectorì—ì„œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì ìš©í•  pod labelì„ ì„ íƒí•œ ë’¤ì—, namespaceSelectorë¡œ ì„ íƒí•œ ë„¤ì„ ìŠ¤í˜ì´ìŠ¤ë¡œë¶€í„°ì˜ ìš”ì²­ë§Œ í—ˆìš©í•˜ëŠ” ì„¤ì •

### 3ï¸âƒ£ egress
- ì–´ë–¤ íŠ¸ë˜í”½ì´ íŒŒë“œ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ìˆ˜ ìˆëŠ”ì§€ ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½ ê·œì¹™ ì •ì˜
- To, ports í•„ë“œë¥¼ í†µí•´ ëª©ì ì§€ì™€ í¬íŠ¸ ì§€ì • ê°€ëŠ¥
- ex) ë°±ì—”ë“œ ì„œë¹„ìŠ¤ê°€ ì˜ë„ì¹˜ ì•Šì€ ì™¸ë¶€ì— ì—°ê²°ë˜ëŠ” ê²ƒì„ ì°¨ë‹¨

`allow-egress-to-nginx.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-to-nginx
spec:
  podSelector:
    matchLabels:
      run: client
  policyTypes:
    - Egress
  egress:
    - to:
      - podSelector:
          matchLabels:
            app:nginx
      ports:
      - protocol: TCP
        port: 80
```

```bash
kubectl run nginx --image=nginx --labels="app=nginx" --port=80
kubectl run client --image=busybox:1.28 --restart=Never -it --rm -- sh

# curl http://nginx -> ì„±ê³µ

kubectl apply -f allow-egress-to-nginx.yaml
kubectl run client --image=busybox:1.28 --restart=Never -it --labels="run=client" --rm â€“ sh

# curl http://nginx -> ì„±ê³µ ingress ì œí•œ ì—†ìŒ

# ping 8.8.8.8 # ì‹¤íŒ¨ egress ì •ì±… ì ìš©

# wget http://google.com # ì‹¤íŒ¨

kubectl delete networkpolicy --all
```

### 4ï¸âƒ£ ipBlock
- í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ IP ë˜ëŠ” íŠ¹ì • IP ëŒ€ì—­ì— ëŒ€í•œ í—ˆìš©/ì œí•œ
- except í•„ë“œë¥¼ ì´ìš©í•œ ì˜ˆì™¸ ì„¤ì • ê°€ëŠ¥
- ex) ì¸íŠ¸ë¼ë„· ì„œë¹„ìŠ¤ì˜ ì™¸ë¶€ ì ‘ê·¼ ì œí•œ, íŠ¹ì • IP ë¸”ë™ë¦¬ìŠ¤íŠ¸

`allow-cidr-access.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cidr-access
spec:
  podSelector:
   matchLabels:
     app: nginx
  policyTypes:
    - Ingress
  ingress:
    - from:
      - ipBlock:
        cidr: 192.168.xx.xx/8
        except:
        - 192.168.xx.xx/32
```

```bash
kubectl run nginx --image=nginx --labels="app=nginx" --port=80

kubectl apply -f allow-cidr-access.yaml

kubectl run client --image=busybox:1.28 --restart=Never -it --rm --sh 

#curl http://nginx

kubectl get pod client -o wide # íŒŒë“œ IP í™•ì¸

kubectl delete networkpolicy --all
```

### ğŸ“„ ë„¤íŠ¸ì›Œí¬ ì •ì±… í•µì‹¬ êµ¬ì„±ìš”ì†Œ ìš”ì•½ ì •ë¦¬

**1. Selector** -> ì •ì±…ì´ ì ìš©ë  ëŒ€ìƒ

**2. ingress/egress** -> í—ˆìš© íŠ¸ë˜í”½ ë°©í–¥

**3. from/to** -> ì–´ë””ì„œ ì˜¤ëŠ”ì§€/ ê°€ëŠ”ì§€ ì§€ì •

**4. ports** -> í—ˆìš©í•  í”„ë¡œí† ì½œ/ í¬íŠ¸ ì§€ì •

![](https://velog.velcdn.com/images/alstjr971/post/fb28ae23-e02e-4373-b897-541c2a3576a1/image.png)
