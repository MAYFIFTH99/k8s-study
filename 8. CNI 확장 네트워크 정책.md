ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì •ì±… êµ¬ì„± ìš”ì†Œë“¤ë¡œë§Œìœ¼ë¡œëŠ” ì‹¤ë¬´ í™˜ê²½ì—ì„œ ë°œìƒí•˜ëŠ” ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ êµ¬í˜„í•˜ê¸° ì‰½ì§€ ì•Šë‹¤.

ì´ë¥¼ ë³´ì™„í•´ì£¼ëŠ”ê²Œ ë°”ë¡œ CNI í”ŒëŸ¬ê·¸ì¸ì´ë‹¤.
- CNI ìì²´ì ìœ¼ë¡œ í™•ì¥ëœ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì œê³µ
- ìœ ë£Œ ê¸°ëŠ¥ì´ ë§ê¸´ í•˜ë‹¤.

> ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ L3(IP), L4(Port) ê³„ì¸µì˜ íŠ¸ë˜í”½ë§Œ ì œì–´ ê°€ëŠ¥í•˜ê³ , L7 íŠ¸ë˜í”½ì„ ì œì–´í•  ìˆœ ì—†ë‹¤.

- ì´ ë˜í•œ CNIë¥¼ ì‚¬ìš©í•˜ë©´ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

---

# ğŸ¯ ì¿ ë²„ë„¤í‹°ìŠ¤ í‘œì¤€ NetworkPolicy

1. íŒŒë“œì˜ ìˆ˜ì‹  ë° ì†¡ì‹  íŠ¸ë˜í”½ì„ ì œì–´í•˜ì—¬ íŠ¸ë˜í”½ì„ ì œí•œí•˜ëŠ” í‘œì¤€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤
2. íŒŒë“œ ë ˆë²¨, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, IP ë²”ìœ„ë¥¼ ì§€ì •í•˜ì—¬ L3, L4 ë ˆì´ì–´ì˜ íŠ¸ë˜í”½ ì œì–´ ê°€ëŠ¥
3. ê¸°ë³¸ ì •ì±…ì´ ì—†ìœ¼ë©´ ëª¨ë‘ í—ˆìš© ìƒíƒœë¡œ ë™ì‘í•˜ê³ , ì •ì±… ì„ ì–¸ ì‹œ í—ˆìš©ëœ ì •ì±…ë§Œ í†µì‹  ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ë¨

![](https://velog.velcdn.com/images/alstjr971/post/0db07f5a-731d-43af-a5ce-60800dca70e1/image.png)


# ğŸ“Œ í‘œì¤€ NetworkPolicyì˜ í•œê³„

1. `FQDN`(Fully Qualifed Domain Name) ê¸°ë°˜ ì œì–´ ì§€ì› X
   ğŸ”¹ IP ê¸°ë°˜ì˜ ì •ì±…ì€ ìƒì„± ê°€ëŠ¥í•˜ì§€ë§Œ, **ìˆ˜ì‹œë¡œ ë³€í•˜ëŠ” Podì˜ IP** íŠ¹ì„±ìƒ ë„ë©”ì¸ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ê°€ í•„ìˆ˜ì ì´ë‹¤.<br><br>
2. L7 ë ˆì´ì–´ ì œì–´ ì§€ì› X
   ğŸ”¹ Pod ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ `HTTP Path`, `method`, `Kafka` ë“± `L7 í”„ë¡œí† ì½œ` ë“±ì˜ ì„¸ë¶€ì ì¸ ì •ì±… ë¯¸ì§€ì›<br><br>
3. TLS ì—°ê´€ ì •ì±… ë¯¸ì§€ì›
   ğŸ”¹ ì•”í˜¸í™” í†µì‹ ì— ëŒ€í•œ ì •ì±…ì´ ë³„ë„ë¡œ ì§€ì›ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, `ServiceMesh`ë‚˜ `Ingres Controller` ì˜ ë³´ì¡° í•„ìš”<br><br>
4. í´ëŸ¬ìŠ¤í„° ë‹¨ìœ„ ì •ì±… ë“±ì˜ ì¼ê´„ì  ì •ì±… ì ìš© ë¯¸ì§€ì›
   ğŸ”¹ `í´ëŸ¬ìŠ¤í„° ë‚´ ëª¨ë“ ` ë…¸ë“œ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, íŒŒë“œì— ì ìš© í›„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ì •ì±…ì´ ë³„ë„ ì¡´ì¬ X<br><br>
5. ë„¤íŠ¸ì›Œí¬ ì •ì±…ì´ ì ìš©ëœ ëŒ€ìƒë“¤ì— ëŒ€í•œ `ë¡œê¹… ê¸°ëŠ¥` ì§€ì› X
   ğŸ”¹ ì ìš©í•œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ê³¼ ë§¤ì¹­ë˜ëŠ” ë¡œê·¸ë¥¼ ì¶œë ¥ë˜ëŠ” ê¸°ëŠ¥ì´ë‚˜, ì‹¤ì‹œê°„ ë¡œê¹…ì„ í†µí•œ ê°€ì‹œì„± í™•ë³´ ë“±ì˜ ê¸°ëŠ¥ ì§€ì› X<br><br>


## 1ï¸âƒ£ Calico 

### âœ…GlobalNetworkPolicy
  ğŸ”¹ `Calico`ì—ì„œ ì œê³µí•˜ëŠ” `í™•ì¥ ë„¤íŠ¸ì›Œí¬ ì •ì±…`ìœ¼ë¡œ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— êµ­í•œë˜ì§€ ì•Šê³  í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ì ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
  ğŸ”¹ ëª…ì‹œì  ì°¨ë‹¨ ê¸°ëŠ¥(action:Deny), DNS ê¸°ë°˜ ì œì–´, ì •ì±… ìš°ì„  ìˆœìœ„(tier, order) ë“± ë‹¤ì–‘í•œ í™•ì¥ ê¸°ëŠ¥ ì§€ì›
  ğŸ”¹ log: true ì„¤ì •ì„ í†µí•œ ì •ì±…ê³¼ ë§¤ì¹­ë˜ëŠ” ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆëŠ” ë¡œê¹… ê¸°ëŠ¥ë„ ì§€ì›í•¨
  
- ì˜ˆì‹œ

`ëª…ì‹œì  Deny` 
```yaml
apiVersion: protectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: deny-ssh
spec:
  selector: all()
  ingress:
    - action: Deny # ëª…ì‹œì  ì°¨ë‹¨!
    destination:
      ports: [22]
  types:
    - Ingress
```

`íŠ¹ì • ë„ë©”ì¸ í—ˆìš©`
```yaml
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: allow-egress-to-domains
spec:
  selector: all()
  types:
  - Egress
  egress:
    - action: Allow
    protocol: UDP
    destination:
      ports:
        - 53
    - action: Allow
    destination: # íŠ¹ì • ë„ë©”ì¸ í—ˆìš© ê¸°ëŠ¥!(ìœ ë£Œ ê¸°ëŠ¥)
      domains:
        - api.example.com
        - '*.example.org'
```

> ğŸš¨ DNS ê¸°ë°˜ ì œì–´ ê¸°ëŠ¥ì€ Calicoì˜ ìœ ë£Œ ë²„ì „ë§Œ ì§€ì›í•œë‹¤

### âœ…StagedNetworkPolicy
ğŸ”¹ Calicoì—ì„œ ì œê³µí•˜ëŠ” ì •ì±… ì‹œë®¬ë ˆì´ì…˜ ë° ë‹¨ê³„ì  ì ìš©ì„ ìœ„í•œ í™•ì¥ ë¦¬ì†ŒìŠ¤
ğŸ”¹ ì‹¤ìˆ˜ë¡œ ëª¨ë“  íŠ¸ë˜í”½ì„ ì°¨ë‹¨í•˜ëŠ” ë¬¸ì œ ë°©ì§€, ì •ì±… ì¶©ëŒ ì›ì¸ íŒŒì•…ì— ìœ ìš©
ğŸ”¹ ì ìš© ì „, ì ìš© í›„ë¡œ ë‚˜ëˆ„ì–´ ì„¸ë°€í•œ íŠ¸ë˜í”½ ì œì–´ ê°€ëŠ¥

`ëª¨ë“  Ingress íŠ¸ë˜í”½ì„ ê¸°ë¡(Log)ë§Œ ìˆ˜í–‰`
```yaml
# only logging ingress traffic without block
apiVersion: projectcalico.org/v3
kind: StagedNetworkPolicy
metadata:
  name: log-all-ingress
spec:
  selector: app == "web"
  ingress:
    preRules:
      - action: Log
        source:
          nets:
            - 0.0.0.0/0

```
`ëª¨ë“  Ingress íŠ¸ë˜í”½ì„ ê¸°ë¡í•˜ê³ , ê·¸ì¤‘ SSH(22ë²ˆ í¬íŠ¸)ë§Œ ì°¨ë‹¨`
```yaml
# logging all ingress & only block 22 port
apiVersion: projectcalico.org/v3
kind: StagedNetworkPolicy
metadata:
  name: deny-ssh-after-log
spec:
  selector: all()
  ingress:
    preRules:
      - action: Log
    postRules:
      - action: Deny
        destination:
          ports: [22]

```

> ğŸ§ `StagedNetworkPolicy`ëŠ” Calicoì˜ "ë¯¸ë¦¬ ì‹œë®¬ë ˆì´ì…˜" ê¸°ëŠ¥ìœ¼ë¡œ,
ğŸ”¹ ì‹¤ì œë¡œ íŠ¸ë˜í”½ì„ ì°¨ë‹¨í•˜ì§€ ì•Šê³ , ì–´ë–¤ ì •ì±…ì´ ì–´ë–¤ íŠ¸ë˜í”½ì— ì ìš©ë ì§€ ì‚¬ì „ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
ğŸ”¹ ìš´ì˜ ì¤‘ì¸ ì‹œìŠ¤í…œì— ì˜í–¥ì„ ìµœì†Œí™”í•˜ë©° ì •ì±…ì„ ì‹¤í—˜í•  ìˆ˜ ìˆëŠ” ì•ˆì „í•œ ë°©ë²•

---

## 2ï¸âƒ£ Cilium
### âœ…CiliumNetworkPolicy
ğŸ”¹ Ciliumì—ì„œ ì œê³µí•˜ëŠ” í™•ì¥ ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ë¡œ, ë‹¤ì–‘í•œ L7 íŠ¸ë˜í”½ ì„¸ë°€ ì œì–´ ì§€ì›
ğŸ”¹ Hubble UIë¥¼ í†µí•œ ì •ì±… ì ìš© ê²°ê³¼ í™•ì¸ ê°€ëŠ¥
 &nbsp;&nbsp;&nbsp;&nbsp; ğŸ”¸ íŠ¸ë˜í”½ ì¶”ì  ì§€ì› ë“±ì˜ ì •ì±… ì ìš© í›„ ê°€ì‹œì„± ì§€ì›
ğŸ”¹ IP, FQDN ì™¸ì—ë„ íŒŒë“œì˜ Security Identityë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” `Identity` ì •ì±… ì ìš© ì§€ì›

`allow-get-healthz.yaml`
```yaml
# only allow GET /healthz req
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-get-healthz
spec:
  endpointSelector:
    matchLabels:
      app: my-api
  ingress:
    - fromEndpoints:
        - matchLabels:
            app: frontend
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
          rules:
            http:
              - method: GET
                path: "/healthz"
```

`allow-egress-to-openai.yaml`
```yaml
# only allow specific domain (openai)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-egress-to-openai
spec:
  endpointSelector:
    matchLabels: {}
  egress:
    - toFQDNs:
        - matchName: "api.openai.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
```

### âœ…CiliumClusterWideNetworkPolicy
ğŸ”¹ `GlobalNetworkPolicy` ê°™ì´ í´ëŸ¬ìŠ¤í„° ì „ì²´ ì›Œí¬ë¡œë“œì— ì ìš© ëª©ì ìœ¼ë¡œ ì§€ì›í•˜ëŠ” ë¦¬ì†ŒìŠ¤
ğŸ”¹ CiliumNetworkPolicyì˜ ì „ì—­ ì¼ê´„ ì ìš©ì´ í•„ìš”í•œ ê²½ìš° `CiliumCluster*wide*NetworkPolicy`ë¥¼ í™œìš©

`allow-openai-egress.yaml`

```yaml
# only openai domain across the cluster
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-openai-egress
spec:
  endpointSelector:
    matchLabels: {}
  egress:
    - toFQDNs:
        - matchName: "api.openai.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
```

`allow-get-status.yaml`
```yaml
# only allow /status req in all namespaces
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-get-status
spec:
  endpointSelector:
    matchLabels:
      role: api
  ingress:
    - fromEndpoints:
        - matchLabels:
            role: client
      toPorts:
        - ports:
            - port: "80"
          rules:
            http:
              - method: GET
                path: "/status"

```

---

# ğŸ› ï¸ ì£¼ìš” CNI ë„¤íŠ¸ì›Œí¬ ì •ì±… ë¹„êµ

![](https://velog.velcdn.com/images/alstjr971/post/2d6bc05b-9c23-4434-b0bd-08652d9a5bef/image.png)

## ğŸŸ¢ DNS ê¸°ë°˜ ì •ì±… ì œì–´


ğŸ”¹`Calico`ëŠ” `GlobalNetworkPolicy`ì˜ `egress` ê·œì¹™ì—ì„œ `destination.domains` í•„ë“œë¥¼ ì‚¬ìš©í•´ ì§€ì› ê°€ëŠ¥
ğŸ”¹ë‚´ë¶€ì ìœ¼ë¡œëŠ” DNSë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì¡°íšŒí•´ IPë¥¼ ê³„ì‚°í•˜ëŠ” DNS IP ìºì‹± ê¸°ë°˜ìœ¼ë¡œ ë™ì‘
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸dnsPolicyê°€ ì ìš©ëœ `kube-dns` , `CoreDNS`ë¥¼ í†µí•´ FQDN->IP ë³€í™˜ í›„ í•´ë‹¹ IP ì— ëŒ€í•œ egress ê·œì¹™ì„ ì ìš©
ğŸ”¹ë‹¨, í•´ë‹¹ ë„ë©”ì¸ìœ¼ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ë§Œ ì •ì±…ì´ ì ìš©ë˜ë©°, DNS ì¿¼ë¦¬ íŒ¨í„´ ë§¤ì¹­ ë“±ì˜ ê³ ê¸‰ ê¸°ëŠ¥ì€ ì§€ì› X  

```yaml
# DNS policy example
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: allow-egress-to-domains
spec:
  selector: all()
  types:
    - Egress
  egress:
    - action: Allow
      protocol: UDP
      destination:
        ports:
          - 53
    - action: Allow
      destination:
        domains:
          - api.example.com
          - '*.example.org'

```

---
ğŸ”¹`Cilium`ì€ `CiliumNetworkPolicy`ì—ì„œ `toFQDN` í•„ë“œë¥¼ ì‚¬ìš©í•´ ë„ë©”ì¸ ê¸°ë°˜ ì œì–´ ì§€ì›
ğŸ”¹ë˜í•œ, `toPorts`ì˜ `rules.dns.matchPattern`ì„ í†µí•´ì„œë„ íŒ¨í„´ ë§¤ì¹­ ê¸°ë°˜ì˜ ë„ë©”ì¸ ê¸°ë°˜ ì œì–´ ì§€ì›
ğŸ”¹Ciliumì€ `eBPF` ê¸°ë°˜ `DNS request` ê°€ë¡œì±„ê¸°ë¥¼ ìˆ˜í–‰í•˜ë©°, ì‹ë³„ëœ IPì— ëŒ€í•´ ì»¤ë„ ë ˆë²¨ì—ì„œ ì œì–´ ìˆ˜í–‰
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸eBPF DNS Trackerë¥¼ ì‚¬ìš©í•œ DNS ìš”ì²­ ë° ì‘ë‹µ ì‹¤ì‹œê°„ íŠ¸ë˜í‚¹ ìˆ˜í–‰ -> DNS ì¿¼ë¦¬ í•„í„°ë§ ë“±ì˜ ê°•ë ¥í•œ ê¸°ëŠ¥ ì§€ì›
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ë„ë©”ì¸ê³¼ ë§¤ì¹­ë˜ëŠ” IPê°€ ë³€ê²½ë  ê²½ìš°, ìë™ìœ¼ë¡œ ì •ì±… ë™ê¸°í™”


```yaml
# FQDN policy + DNS pattern matching
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "fqdn"
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
    - toFQDNs:
        - matchPattern: "*.github.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": kube-system
            "k8s:k8s-app": kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY
          rules:
            dns:
              - matchPattern: "*"

```
---
## ğŸŸ¢ L7 ì• í”Œë¦¬ì¼€ì´ì…˜ ì œì–´
ğŸ”¹ `Calico`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ HTTP ë©”ì†Œë“œ, URL ê²½ë¡œ ë“±ì˜ ì„¸ë¶€ì ì¸ íŠ¸ë˜í”½ ì •ì±…ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸L7 í•„í„°ë§ ì§€ì›ì„ ìœ„í•´ì„œëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œì™€ì˜ ì—°ë™, í˜¹ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ í•„í„°ë§ ë¦¬ì†ŒìŠ¤ ì—°ë™ í•„ìš”
ğŸ”¹ ApplicationLayerê³¼ ê°™ì€ `custom resource`ë¥¼ í†µí•´ ì œí•œëœ ê¸°ëŠ¥ì„ `GlobalNetworkPolicy`ì— ì ìš© ê°€ëŠ¥
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸Ingress ê·œì¹™, í´ëŸ¬ìŠ¤í„° ë ˆë²¨ì—ë§Œ ì ìš© ê°€ëŠ¥í•œ ì œí•œ ì‚¬í•­ì´ ì¡´ì¬í•¨
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ í”„ë¡œí† ì½œ ë˜í•œ HTTP, HTTPS, gRPC ë“±ì˜ í•œì •ëœ í”„ë¡œí† ì½œë§Œ ì§€ì›

```yaml
# ApplicationLayer Custom Resource
apiVersion: operator.tigera.io/v1
kind: ApplicationLayer
metadata:
  name: tigera-secure
spec:
  applicationLayerPolicy: Enabled
---
# Application Layer policy example
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: customer
spec:
  selector: app == 'tradingapp'
  ingress:
    - action: Allow
      http:
        methods: ["GET"]
        paths:
          - exact: "/projects/calico"
          - prefix: "/users"
  egress:
    - action: Allow

```

---
ğŸ”¹`Cilium`ì€ í¬íŠ¸ ê¸°ë°˜ toPorts ê·œì¹™ ì•„ë˜ L7 í•„í„°ë§ ì •ì±…ì„ ì •ì˜í•˜ì—¬ ì œì–´ ê°€ëŠ¥
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ `rules.http.method`, `rules.http.path` í•„ë“œë¥¼ í†µí•´ HTTP ë©”ì†Œë“œ, ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ ì°¨ë‹¨ ë° í—ˆìš© ê°€ëŠ¥
ğŸ”¹ë˜í•œ, Kafka topicì´ë‚˜ gRPC method ë“±ì˜ í”„ë¡œí† ì½œì— ëŒ€í•œ topic ë° method í•„í„°ë§ ì§€ì›ì´ ê°€ëŠ¥í•¨
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸`rules.kafka`, `rules.grpc` ë“±ì˜ í•„ë“œë¥¼ í†µí•´ ì§€ì›
ğŸ”¹Cilium ë‚´ ë‚´ì¥ëœ eBPF + Envoy Proxyë¥¼ í†µí•´, ì»¤ë„ì—ì„œ L3/L4 ì²˜ë¦¬ ë° ì‚¬ìš©ì ê³µê°„ì—ì„œ L7 í”„ë¡ì‹œ ì²˜ë¦¬

```yaml
# CiliumNetworkPolicy L7 policy
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-healthz
spec:
  endpointSelector:
    matchLabels:
      app: backend
  ingress:
    - fromEndpoints:
        - matchLabels:
            app: frontend
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
          rules:
            http:
              - method: GET
                path: "/healthz"

```
